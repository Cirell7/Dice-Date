{% extends "core/base1.html" %}
{% load static %}

{% block extra_style %}
<link rel="stylesheet" href="{% static 'core/css/base/notifications_page.css' %}" />
{% endblock %}

{% block main %}

<div class="form-container">
    <div class="form-content">
        <div class="form-header">
            <h3>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
            {% if unread_notifications_count > 0 %}
            <button onclick="markAllAsRead()" class="btn-primary">
                üì¨ –ü—Ä–æ—á–∏—Ç–∞—Ç—å –≤—Å–µ
            </button>
            {% endif %}
        </div>

        <div class="notifications-list">
            {% if notifications %}
                {% for notification in notifications %}
                <div class="notification-item {% if not notification.is_read %}unread{% endif %}" 
                     onclick="markAsRead({{ notification.id }})">
                    <div class="notification-content">
                        <div class="notification-text">{{ notification.message }}</div>
                        <div class="notification-time">{{ notification.created_at|timesince }} –Ω–∞–∑–∞–¥</div>
                    </div>
                    {% if not notification.is_read %}
                    <div class="unread-dot"></div>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
                <div class="empty-state">
                    <div class="empty-icon">üéØ</div>
                    <h3>–í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–æ—á–∏—Ç–∞–Ω—ã</h3>
                    <p>–ù–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>
<script>
// JavaScript —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Å—Ç–∞—é—Ç—Å—è —Ç–∞–∫–∏–º–∏ –∂–µ
function markAsRead(notificationId) {
    const formData = new FormData();
    formData.append('notification_id', notificationId);
    
    fetch(`/notifications/${notificationId}/mark-read/`, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const item = document.querySelector(`[onclick="markAsRead(${notificationId})"]`);
            if (item) {
                item.classList.remove('unread');
                const dot = item.querySelector('.unread-dot');
                if (dot) dot.remove();
                updateUnreadCount();
            }
        }
    });
}

function markAllAsRead() {
    fetch(`/mark_all_read/`, {
        method: 'POST',
        body: new FormData()
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.querySelectorAll('.notification-item.unread').forEach(item => {
                item.classList.remove('unread');
                const dot = item.querySelector('.unread-dot');
                if (dot) dot.remove();
            });
            updateUnreadCount();
        }
    });
}

function updateUnreadCount() {
    const unreadCount = document.querySelectorAll('.notification-item.unread').length;
    const badge = document.querySelector('.unread-badge');
    const markAllBtn = document.querySelector('.mark-all-btn');
    
    if (unreadCount > 0) {
        if (badge) badge.textContent = `üìå ${unreadCount} –Ω–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã—Ö`;
    } else {
        if (badge) badge.remove();
        if (markAllBtn) markAllBtn.remove();
    }
}
</script>
{% endblock %}