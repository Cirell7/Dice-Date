{% extends "core/base1.html" %}
{% load static %}

{% block extra_style %}
  <link rel="stylesheet" href="{% static 'pages/css/homepage/post_detail.css' %}" />
  <link rel="stylesheet" href="{% static 'pages/css/homepage/post_detail_list.css' %}" />
{% endblock %}

{% block extra_scripts %}
  <div id="csrf-token" data-csrf="{{ csrf_token }}" style="display: none;"></div>
  <script src="{% static 'js/post_detail.js' %}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—ã–ø–∞–¥–∞—é—â–∏–º —Å–ø–∏—Å–∫–æ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
        const toggleBtn = document.querySelector('.participants-toggle');
        const dropdownContent = document.querySelector('.participants-dropdown-content');
        
        if (toggleBtn && dropdownContent) {
            toggleBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                this.classList.toggle('active');
                dropdownContent.classList.toggle('show');
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            document.addEventListener('click', function(e) {
                if (!toggleBtn.contains(e.target) && !dropdownContent.contains(e.target)) {
                    toggleBtn.classList.remove('active');
                    dropdownContent.classList.remove('show');
                }
            });
            
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –∑–∞–∫—Ä—ã—Ç–∏–µ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω—É—Ç—Ä–∏ —Å–ø–∏—Å–∫–∞
            dropdownContent.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
        
        // –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function adjustDropdownPosition() {
            if (window.innerWidth < 768) {
                dropdownContent.classList.add('fixed');
            } else {
                dropdownContent.classList.remove('fixed');
            }
        }
        
        if (dropdownContent) {
            adjustDropdownPosition();
            window.addEventListener('resize', adjustDropdownPosition);
        }
    });
  </script>
{% endblock %}

{% block main %}
<div class="post-detail-container">
  
  <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø–æ—Å—Ç–∞ -->
  <div class="post-header">
    <h1 class="post-title">{{ post.name }}</h1>
    <div class="post-author-info">
      <!-- –§–æ—Ç–æ –∞–≤—Ç–æ—Ä–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–µ) -->
      <a href="{% url 'profile_view' user_id=post.user.id %}" class="author-link" style="display: inline-flex; align-items: center; gap: 8px; white-space: nowrap;">
        {% if post.user.profile.photo %}
          <img src="{{ post.user.profile.photo.url }}" class="comment-avatar-img" alt="{{ post.user.username }}">
        {% else %}
          <div class="author-photo default-avatar">{{ post.user.username|first|upper }}</div>
        {% endif %}
        {{ post.user.username }}
      </a>
      
      

  <p class="post-description">{{ post.description }}</p>

  
  <!-- –ú–µ—Ç–∞-–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
  <div class="post-meta-grid">
    <div class="meta-item">
      <span class="meta-icon">üìÖ</span>
      <span class="meta-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
      <span class="meta-value">{{ post.creation_date|date:"d.m.Y H:i" }}</span>
    </div>
    
    <div class="meta-item">
      <span class="meta-icon">‚è∞</span>
      <span class="meta-label">–ö–æ–≥–¥–∞:</span>
      <span class="meta-value">{{ post.expiration_date|date:"d.m.Y H:i" }}</span>
    </div>
    
    <div class="meta-item">
      <span class="meta-icon">üìç</span>
      <span class="meta-label">–ì–¥–µ:</span>
      <span class="meta-value">{{ post.address }}</span>
    </div>
    
    <div class="meta-item">
      <!-- –°—á–µ—Ç—á–∏–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ —Å–æ —Å—Ç—Ä–µ–ª–æ—á–∫–æ–π -->
      {% if approved_participants_count > 0 %}
      <div class="participants-dropdown">
        <button class="participants-toggle">
          <span>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: {{ approved_participants_count }}/{{ post.max_participants }}</span>
          <span class="arrow">‚ñº</span>
        </button>
        
        <div class="participants-dropdown-content">
          <div class="participants-list">
            <!-- –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤—ã–π -->
            <div class="participant-item">
              <div class="comment-author-block">
                <a href="{% url 'profile_view' user_id=post.user.id %}" class="author-link">
                  {% if post.user.profile.photo %}
                    <img src="{{ post.user.profile.photo.url }}" class="comment-avatar-img" alt="{{ post.user.username }}">
                  {% else %}
                    <div class="comment-avatar-default">{{ post.user.username|first|upper }}</div>
                  {% endif %}
                </a>
                <div class="comment-author-info">
                  <a href="{% url 'profile_view' user_id=post.user.id %}" class="author-link">
                    {{ post.user.username }}
                  </a>
                  <span class="comment-date">üëë –û—Ä–≥–∞–Ω–∏–∑–∞—Ç–æ—Ä</span>
                </div>
              </div>
            </div>
            
            <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏ -->
            {% for participant in participants %}
            <div class="participant-item">
              <div class="comment-author-block">
                <a href="{% url 'profile_view' user_id=participant.user.id %}" class="author-link">
                  {% if participant.user.profile.photo %}
                    <img src="{{ participant.user.profile.photo.url }}" class="comment-avatar-img" alt="{{ participant.user.username }}">
                  {% else %}
                    <div class="comment-avatar-default">{{ participant.user.username|first|upper }}</div>
                  {% endif %}
                </a>
                <div class="comment-author-info">
                  <a href="{% url 'profile_view' user_id=participant.user.id %}" class="author-link">
                    {{ participant.user.username }}
                  </a>
                  <span class="comment-date">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è: {{ participant.joined_at|date:"d.m.Y H:i" }}</span>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>
      {% else %}
      <div class="participants-dropdown">
        <button class="participants-toggle" disabled>
          <span>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏: 0/{{ post.max_participants }}</span>
        </button>
      </div>
      {% endif %}
    </div>
  </div>
  
  <div class="post-footer">
    
    {% if user == post.user %}
      <!-- –î–ª—è –∞–≤—Ç–æ—Ä–∞ –ø–æ—Å—Ç–∞ -->
      <a class="btn btn-primary" href="{% url 'post_edit' post.id %}">
        <span>‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
      </a>
      <a class="btn-outline-secondary" href="{% url 'post_requests' post.id %}">
        <span>üîî –ó–∞—è–≤–∫–∏ ({{ pending_requests_count }})</span>
      </a>
    {% else %}
      <!-- –î–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
        {% if user_has_pending_request %}
          <button class="btn-primary" disabled>
            ‚è≥ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞
          </button>
        {% elif user_is_approved %}
          <button class="btn-primary" disabled>
            ‚úÖ –í—ã —É—á–∞—Å—Ç–Ω–∏–∫
          </button>
        {% elif is_full %}
          <button class="btn-full" disabled>
            ‚ùå –ú–µ—Å—Ç –Ω–µ—Ç
          </button>
        {% else %}
          <form method="post" action="{% url 'join_post' post.id %}" style="display: inline;">
            {% csrf_token %}
            <button type="submit" class="btn-join">
              üéØ –ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è
            </button>
          </form>
        {% endif %}
    {% endif %}
  </div>
  
  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
  <div class="comments-section">
    
    {% for comment in comments %}
    <div class="comment-item">
        <div class="comment-header">
            <div class="comment-author-block">
                <a href="{% url 'profile_view' user_id=comment.user.id %}"  class="author-link" >
                    {% if comment.user.profile.photo %}
                        <img src="{{ comment.user.profile.photo.url }}" class="comment-avatar-img" alt="{{ comment.user.username }}">
                    {% else %}
                        <div class="author-photo default-avatar">{{ comment.user.username|first|upper }}</div>
                    {% endif %}
                </a>
                <div class="comment-author-info">
                    <a href="{% url 'profile_view' user_id=comment.user.id %}" class="author-link">
                        {{ comment.user.username }}
                    </a>
                    <span class="comment-date">{{ comment.created_at|date:"d.m.Y –≤ H:i" }}</span>
                </div>
            </div>
            {% if user == comment.user %}
            <button class="delete-comment" 
                    data-comment-id="{{ comment.id }}"
                    data-post-id="{{ post.id }}">
                üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
            </button>
            {% endif %}
        </div>
        <div class="comment-text">{{ comment.text }}</div>
    </div>
    {% empty %}
    <p class="no-comments">
        –ü–æ–∫–∞ –Ω–µ—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º!
    </p>
    {% endfor %}

    <!-- –§–æ—Ä–º–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è -->
    <div class="comment-form-container">
        <form action="" method="post" style="width: 100%;">
            {% csrf_token %}
            <div class="comment-input-container">
                <textarea name="comment_description" id="comment_description" 
                    placeholder="–ü–æ–¥–µ–ª–∏—Ç–µ—Å—å –≤–∞—à–∏–º–∏ –º—ã—Å–ª—è–º–∏..." required minlength="1" maxlength="500" 
                    class="comment-input"></textarea>
            </div>
            <div class="comment-button-container">
                <button type="submit" class="comment-submit-btn">üì§ –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</button>
            </div>
        </form>
    </div>
  </div>
</div>
{% endblock %}