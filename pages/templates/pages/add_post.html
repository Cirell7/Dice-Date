{% extends 'base/base1.html' %}
{% load static %}

{% block extra_style %}
  <link rel="stylesheet" href="{% static 'css/add_post.css' %}" />
  <link rel="stylesheet" href="{% static 'css/map.css' %}" />
{% endblock %}

{% block extra_scripts %}
  <script src="{% static 'js/add_post.js' %}"></script>
  <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block title %}–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É - Dice&Date{% endblock %}

{% block main %}
<!-- –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–æ–ª–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<div class="fullpage-create-container">
    <div class="create-meetup-hero">
        <div class="hero-background"></div>
        
        <div class="create-meetup-content">
            <!-- –õ–µ–≤–∞—è —á–∞—Å—Ç—å - —Ñ–æ—Ä–º–∞ -->
            <div class="form-container">
                <div class="form-header">
                    <button class="back-btn" onclick="window.history.back()">
                        ‚Üê –ù–∞–∑–∞–¥
                    </button>
                    <h1>–°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É</h1>
                    <p>–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–∏</p>
                </div>

                <form class="meetup-form" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
                    <div class="form-section">
                        <h3>üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                        
                        <div class="form-group">
                            <label for="title">–ù–∞–∑–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏ *</label>
                            <input type="text" id="title" name="title" required 
                                   placeholder="–ö–æ—Ñ–µ –≤ —Ü–µ–Ω—Ç—Ä–µ, –ü—Ä–æ–≥—É–ª–∫–∞ –≤ –ø–∞—Ä–∫–µ...">
                        </div>

                        <div class="form-group">
                            <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ –≤—Å—Ç—Ä–µ—á–∏</label>
                            <textarea id="description" name="description" rows="4"
                                      placeholder="–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –±—É–¥–µ—Ç –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å..."></textarea>
                        </div>
                    </div>

                    <!-- –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è -->
                    <div class="form-section">
                        <h3>üìÖ –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è</h3>
                        
                        <div class="form-group">
                            <label for="event_date">–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –≤—Å—Ç—Ä–µ—á–∏ *</label>
                            <input type="datetime-local" id="event_date" name="event_date" required>
                        </div>
                    </div>

                    <!-- –ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏ -->
                    <div class="form-section">
                        <h3>üìç –ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏</h3>
                        
                        <div class="form-group">
                            <label for="address">–ú–µ—Å—Ç–æ –≤—Å—Ç—Ä–µ—á–∏</label>
                            <input type="text" id="address" name="address" 
                                   placeholder="–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π –ø–∞—Ä–∫, –∫–∞—Ñ–µ '–ö–æ—Ñ–µ–π–Ω—è'...">
                        </div>
                    </div>
                    <div class="form-section">
                        <!-- –ö–∞—Ä—Ç–∞ -->
                        <div class="map-container">
                            <div id="map" style="width: 100%; height: 300px; border-radius: 12px;"></div>
                            <div class="map-controls">
                                <button type="button" id="find-me" class="btn-map">üìç –ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</button>
                                <button type="button" id="clear-map" class="btn-map">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                            </div>
                            <small>–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—Ç–æ –Ω–∞ –∫–∞—Ä—Ç–µ</small>
                        </div>
                        <input type="hidden" id="latitude" name="latitude">
                        <input type="hidden" id="longitude" name="longitude">
                    </div>

                    <!-- –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ —Ñ–æ—Ç–æ -->
                    <div class="form-section">
                        <h3>üë• –£—á–∞—Å—Ç–Ω–∏–∫–∏ –∏ —Ñ–æ—Ç–æ</h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="max_participants">–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤</label>
                                <input type="number" id="max_participants" name="max_participants" 
                                       value="10" min="2" max="50">
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="image">–§–æ—Ç–æ –≤—Å—Ç—Ä–µ—á–∏</label>
                            <div class="file-upload-area">
                                <input type="file" id="image" name="image" accept="image/*">
                                <div class="upload-content">
                                    <span class="upload-icon">üìÅ</span>
                                    <span class="upload-text">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ</span>
                                    <span class="file-hint">–∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞</span>
                                </div>
                                <div class="file-name" id="file-name"></div>
                            </div>
                        </div>
                    </div>

                    <!-- –ö–Ω–æ–ø–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">
                            üéØ –°–æ–∑–¥–∞—Ç—å –≤—Å—Ç—Ä–µ—á—É
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
ymaps.ready(init);

let map, placemark;

function init() {
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
    map = new ymaps.Map('map', {
        center: [55.76, 37.64], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        zoom: 10
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ
    map.events.add('click', function (e) {
        const coords = e.get('coords');
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
        document.getElementById('latitude').value = coords[0];
        document.getElementById('longitude').value = coords[1];
        
        // –ï—Å–ª–∏ –º–µ—Ç–∫–∞ —É–∂–µ –µ—Å—Ç—å - —É–¥–∞–ª—è–µ–º
        if (placemark) {
            map.geoObjects.remove(placemark);
        }
        
        // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—É—é –º–µ—Ç–∫—É
        placemark = new ymaps.Placemark(coords, {}, {
            preset: 'islands#redDotIcon'
        });
        
        map.geoObjects.add(placemark);
        
        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º
        ymaps.geocode(coords).then(function (res) {
            const firstGeoObject = res.geoObjects.get(0);
            const address = firstGeoObject.getAddressLine();
            document.getElementById('address').value = address;
        });
    });

    // –ö–Ω–æ–ø–∫–∞ "–ú–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ"
    document.getElementById('find-me').addEventListener('click', function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                const coords = [position.coords.latitude, position.coords.longitude];
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤ —Å–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è
                document.getElementById('latitude').value = coords[0];
                document.getElementById('longitude').value = coords[1];
                
                map.setCenter(coords, 15);
                
                if (placemark) {
                    map.geoObjects.remove(placemark);
                }
                
                placemark = new ymaps.Placemark(coords, {}, {
                    preset: 'islands#blueHomeIcon'
                });
                
                map.geoObjects.add(placemark);
                
                // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å
                ymaps.geocode(coords).then(function (res) {
                    const firstGeoObject = res.geoObjects.get(0);
                    const address = firstGeoObject.getAddressLine();
                    document.getElementById('address').value = address;
                });
            });
        }
    });

    // –ö–Ω–æ–ø–∫–∞ "–û—á–∏—Å—Ç–∏—Ç—å"
    document.getElementById('clear-map').addEventListener('click', function() {
        if (placemark) {
            map.geoObjects.remove(placemark);
            placemark = null;
        }
        document.getElementById('address').value = '';
        // –û—á–∏—â–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
        document.getElementById('latitude').value = '';
        document.getElementById('longitude').value = '';
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ (–≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ)
    document.getElementById('address').addEventListener('change', function() {
        const address = this.value;
        if (address) {
            ymaps.geocode(address).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                if (firstGeoObject) {
                    const coords = firstGeoObject.geometry.getCoordinates();
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã
                    document.getElementById('latitude').value = coords[0];
                    document.getElementById('longitude').value = coords[1];
                    
                    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–µ—Ç–∫—É
                    if (placemark) {
                        map.geoObjects.remove(placemark);
                    }
                    
                    placemark = new ymaps.Placemark(coords, {}, {
                        preset: 'islands#greenDotIcon'
                    });
                    
                    map.geoObjects.add(placemark);
                    map.setCenter(coords, 15);
                }
            });
        }
    });
}
</script>
{% endblock %}