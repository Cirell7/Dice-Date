{% extends "core/base1.html" %}
{% load static %}

{% block extra_style %}
  <link rel="stylesheet" href="{% static 'pages/css/homepage/post_list.css' %}" />
{% endblock %}

{% block extra_scripts %}
  <!-- API –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç -->
  <script src="https://api-maps.yandex.ru/2.1/?apikey=–í–ê–®_API_–ö–õ–Æ–ß&lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block main %}
<div class="container">
    <h1>–í—Å–µ –≤—Å—Ç—Ä–µ—á–∏</h1>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞—Ä—Ç—ã -->
    <div class="map-section mb-4">
        <h3>üó∫Ô∏è –ö–∞—Ä—Ç–∞ –≤—Å—Ç—Ä–µ—á</h3>
        <div id="posts-map" style="width: 100%; height: 400px; border-radius: 12px; margin-bottom: 20px;"></div>
    </div>
    
    {% for post in posts %}
    <div class="post-card mb-4 p-4 border rounded" data-post-id="{{ post.id }}" 
        data-post-name="{{ post.name }}" 
        data-post-address="{{ post.address }}"
        data-post-url="{% url 'post_detail' post.id %}"
        {% if post.latitude and post.longitude %}
        data-lat="{{ post.latitude }}"
        data-lng="{{ post.longitude }}"
        {% endif %}>
        <div class="post-header">
            <div class="author-info">
                <!-- –§–æ—Ç–æ –∞–≤—Ç–æ—Ä–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è (–∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ–µ) -->
                <a href="{% url 'profile_view' user_id=post.user.id %}" class="author-photo-link">
                    {% if post.user.profile.photo %}
                        <img src="{{ post.user.profile.photo.url }}" class="author-photo" alt="{{ post.user.username }}">
                    {% else %}
                        <div class="author-photo default-avatar">{{ post.user.username|first|upper }}</div>
                    {% endif %}
                </a>
                <div class="author-details">
                    <h2><a href="{% url 'post_detail' post.id %}">{{ post.name }}</a></h2>
                    <p>
                        <strong>–ê–≤—Ç–æ—Ä:</strong> 
                        <a href="{% url 'profile_view' user_id=post.user.id %}" class="author-link">
                            {{ post.user.username }}
                        </a>
                    </p>
                </div>
            </div>
            <p><strong>–ö–æ–≥–¥–∞:</strong> {{ post.expiration_date|date:"d.m.Y H:i" }}</p>
            <p><strong>–ì–¥–µ:</strong> {{ post.address }}</p>
            <p><strong>–ú–∞–∫—Å–∏–º—É–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤:</strong> {{ post.max_participants }}</p>
        </div>
        
        <div class="post-description">
            <p>{{ post.description }}</p>
        </div>
        
        {% if post.image %}
        <div class="post-image">
            <img src="{{ post.image.url }}" class="img-fluid" style="max-height: 300px;" />
        </div>
        {% endif %}
        
        <div class="post-footer mt-3">
            <a href="{% url 'post_detail' post.id %}" class="btn btn-primary">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</a>
            <span class="text-muted ms-3">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏: {{ post.comments.count }}</span>
            <button type="button" class="btn btn-outline-secondary btn-sm show-on-map" 
                    data-post-id="{{ post.id }}">
                üìç –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ
            </button>
        </div>
    </div>
    {% empty %}
    <p>–ü–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –≤—Å—Ç—Ä–µ—á. <a href="{% url 'add_post' %}">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é!</a></p>
    {% endfor %}
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
ymaps.ready(init);

let postsMap;
let placemarks = [];

function init() {
    // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É
    postsMap = new ymaps.Map('posts-map', {
        center: [55.76, 37.64], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        zoom: 10
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –º–µ—Ç–∫–∏ –¥–ª—è –≤—Å–µ—Ö –ø–æ—Å—Ç–æ–≤
    addPostsToMap();

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ"
    document.querySelectorAll('.show-on-map').forEach(button => {
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            showPostOnMap(postId);
        });
    });
}

function addPostsToMap() {
    const postCards = document.querySelectorAll('.post-card');
    
    postCards.forEach(card => {
        const lat = card.getAttribute('data-lat');
        const lng = card.getAttribute('data-lng');
        const name = card.getAttribute('data-post-name');
        const address = card.getAttribute('data-post-address');
        const url = card.getAttribute('data-post-url');
        
        if (lat && lng) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã - —Å—Ç–∞–≤–∏–º —Ç–æ—á–Ω—É—é –º–µ—Ç–∫—É
            const placemark = new ymaps.Placemark([parseFloat(lat), parseFloat(lng)], {
                balloonContent: `
                    <strong><a href="${url}">${name}</a></strong><br>
                    ${address}<br>
                    <a href="${url}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—Å—Ç—Ä–µ—á–µ ‚Üí</a>
                `
            }, {
                preset: 'islands#blueDotIcon'
            });
            
            postsMap.geoObjects.add(placemark);
            placemarks.push({
                id: card.getAttribute('data-post-id'),
                placemark: placemark
            });
        } else if (address) {
            // –ï—Å–ª–∏ –Ω–µ—Ç –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç, –Ω–æ –µ—Å—Ç—å –∞–¥—Ä–µ—Å - –≥–µ–æ–∫–æ–¥–∏—Ä—É–µ–º
            ymaps.geocode(address).then(function (res) {
                const firstGeoObject = res.geoObjects.get(0);
                if (firstGeoObject) {
                    const coords = firstGeoObject.geometry.getCoordinates();
                    
                    const placemark = new ymaps.Placemark(coords, {
                        balloonContent: `
                            <strong><a href="${url}">${name}</a></strong><br>
                            ${address}<br>
                            <a href="${url}">–ü–µ—Ä–µ–π—Ç–∏ –∫ –≤—Å—Ç—Ä–µ—á–µ ‚Üí</a>
                        `
                    }, {
                        preset: 'islands#redDotIcon'
                    });
                    
                    postsMap.geoObjects.add(placemark);
                    placemarks.push({
                        id: card.getAttribute('data-post-id'),
                        placemark: placemark
                    });
                }
            });
        }
    });
}

function showPostOnMap(postId) {
    // –ù–∞—Ö–æ–¥–∏–º –º–µ—Ç–∫—É –ø–æ—Å—Ç–∞
    const postMark = placemarks.find(item => item.id === postId);
    if (postMark) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –±–∞–ª—É–Ω –∏ —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É
        postMark.placemark.balloon.open();
        postsMap.setCenter(postMark.placemark.geometry.getCoordinates(), 15);
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –∫–∞—Ä—Ç–æ—á–∫—É –ø–æ—Å—Ç–∞
        document.querySelectorAll('.post-card').forEach(card => {
            card.style.backgroundColor = '';
        });
        document.querySelector(`[data-post-id="${postId}"]`).style.backgroundColor = '#f0f8ff';
    }
}
</script>

<style>
.post-card {
    transition: background-color 0.3s ease;
}

.show-on-map {
    margin-left: 10px;
}

.map-section {
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
</style>
{% endblock %}